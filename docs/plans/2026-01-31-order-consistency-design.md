# 订单链路一致性设计

日期：2026-01-31

## 背景与目标

当前订单链路存在一致性风险：订单项字段为占位、库存扣减未走库存服务、缺少事务包裹、下单时未再次校验库存。目标是在不扩大范围的前提下，优先保证功能正确性与一致性：订单、订单项、库存、购物车状态在同一事务内原子成功或失败。

## 范围与非目标

范围：下单流程中“创建订单 + 创建订单项 + 库存读取与校验 + 库存扣减 + 清空购物车”纳入同一事务；订单项写入真实商品信息；库存扣减统一经 InventoryService；库存不足返回明确错误。

非目标：并发防超卖的锁/原子更新策略、幂等下单、性能优化与异步化。

## 方案概述

以 `internal/service/order_service.go` 的 `CreateOrder` 为事务组织者，开启事务并在事务内完成：

1. 读取购物车或请求内商品清单。
2. 批量读取商品详情并填充订单项字段（名称、SKU、价格等）。
3. 读取库存并校验是否足够。
4. 调用 `InventoryService.AdjustStock` 扣减库存并记录日志。
5. 创建订单与订单项。
6. 清空购物车。

任一步骤失败则回滚，避免部分成功。

## 组件职责与数据流

- 订单服务：组织事务、组装订单与订单项、处理业务错误。
- 商品仓储：批量读取商品快照信息。
- 库存服务：执行扣减与库存日志写入。
- 购物车服务：清空购物车。

数据流：下单请求进入订单服务 -> 读取购物车/商品 -> 批量读取商品详情 -> 组装订单与订单项 -> 库存读取与校验 -> 扣减库存（含日志） -> 写入订单与订单项 -> 清空购物车 -> 提交事务。

## 错误处理

- 库存不足：返回明确业务错误，事务回滚。
- 商品缺失/不可售：事务回滚并返回业务错误。
- 库存服务异常/数据库异常：事务回滚并返回通用错误。
- 购物车清空失败：事务回滚，避免订单成功但购物车残留。

## 测试建议

1. 下单成功：订单、订单项、库存、购物车状态一致。
2. 库存不足：订单与订单项不落库、库存不变、购物车不清。
3. 商品缺失/不可售：与库存不足同等处理。
4. 库存服务失败：事务回滚。
5. 购物车清空失败：事务回滚。

## 后续可能扩展

在本方案稳定后，可引入并发安全的库存更新策略（原子更新或锁）、幂等下单与可观测性增强。
